# 红黑树

## 一、红黑树（Red Black Tree）

### 1、初识红黑树



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153541231.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 红黑树也是一种自平衡的二叉搜索树，也曾叫做平衡二叉B树。
- 红黑树必须满足以下5条性质：
  - `节点`是`RED`或者`BLACK`
  - `根节点`是`BLACK`
  - `叶子节点`（外部节点，空节点）都是`BLACK`
  - RED节点的子节点都是BLACK
    - `RED`节点的`parent`都是`BLACK`
    - 从`根节点`到`叶子节点`的所有路径上不能有`2`个连续的`RED`节点
  - 从任意节点到`叶子节点`的所有路径都包含相同数目的`BLACK`节点。
- 在`添加`和`删除`节点之后，让树依然满足以上`5`条性质，就可以保证平衡。

### 2、红黑树的等价变化



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153550394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 我们将红黑树的红色节点上移靠近父节点。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153559424.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- `红黑树`和`4阶B树`具有等价性。

- `BLACK`节点与它的`RED`子节点融合在一起，形成`1`个B树节点。

- 红黑树的`BLACK`节点数与`4阶B树`的节点总个数`相等`。

### 3、红黑树 vs 2-3-4树

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153615471.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 如果上图最底层的`BLACK`节点不存在，那么整颗B树只有`一个`节点，而且是`超级节点`。

### 4、红黑树节点关系



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153623479.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 父节点（parent）
  - `55`是`38`和`80`的`父节点`，`38`是`25`和`46`的`父节点`。
- 兄弟节点（sibling）
  - `25`和`46`是`兄弟节点`，`76`和`88`是`兄弟节点`。
- 叔父节点（parent的兄弟节点）
  - `25`和`46`的`叔父节点`是`80`。
- 祖父节点（parent的父节点）
  - `25`的`祖父节点`是`55`。

## 二、红黑树的实现

### 1、构造方法

- 除了构造函数，还提供一些辅助函数，在之后会使用。

```java
// 红黑树继承于二叉平衡搜索树，这里只列出红黑树特有的属性。
public class RBTree<E> extends BBST<E> {
    private static final boolean RED = false;
    private static final boolean BLACK = true;
	
    @Override
    protected Node<E> createNode(E element, Node<E> parent) {
        return new RBNode<>(element, parent);
    }

    // 构造一个红黑节点，默认为红色
    private static class RBNode<E> extends Node<E> {
        boolean color = RED; //
        public RBNode(E element, Node<E> parent) {
            super(element, parent);
        }
    }
	
    // 节点染色
    private Node<E> color(Node<E> node, boolean color) {
        if (node == null) return node;
        ((RBNode<E>)node).color = color;
        return node;
    }
	
    // 将节点染为红色
    private Node<E> red(Node<E> node) {
        return color(node, RED);
    }
	
    // 将节点染为黑色
    private Node<E> black(Node<E> node) {
        return color(node, BLACK);
    }
	
    // 节点的颜色
    private boolean colorOf(Node<E> node) {
        return node == null ? BLACK : ((RBNode<E>)node).color;
    }
	
    // 是否为黑色节点
    private boolean isBlack(Node<E> node) {
        return colorOf(node) == BLACK;
    }
	
    // 是否为红色节点
    private boolean isRed(Node<E> node) {
        return colorOf(node) == RED;
    }
    
    public boolean isLeftChild() {
        return parent != null && this == parent.left;
    }
		
    public boolean isRightChild() {
        return parent != null && this == parent.right;
    }
	
    // 获取兄弟节点	
    public Node<E> sibling() {
        if (isLeftChild()) {
            return parent.right;
        }
			
        if (isRightChild()) {
            return parent.left;
        }
        return null;
    }
}
```

### 2、添加

- 通过之前的学习，我们知道：

  - B树中，`新元素`必定是添加到`叶子节点`中。
  - `4阶B树`所有节点的元素个数`x`，都符合`1 <= x <= 3`。

- 建议新添加的节点默认为`RED`，这样能够让红黑树的性质尽快满足（初识红黑树中的5条性质，除了性质4不一定满足）。

- 如果添加的是根节点，染成BLACK即可。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153632416.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- 因为`新元素`必定是添加到`叶子节点`中，所以`红黑树`的添加一共有`12`种情况，分为`17`的`左右`，`33`的`左右`，`46`的`左`，`50`的`左右`，`72`的`左右`，`76`的`右`，`88`的`左右`。

- 其中`4`种是`parent为BLACK`的情况，有`8`种是`parent为RED`的情况。

#### 2.1 parent为BLACK

- 有`4`种情况满足红黑树的性质4：`parent为BLACK`。

- 并且同样也满足4阶B树的性质，因此不用做任何额外处理。

  !![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153640680.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2 parent为RED（Double Red）

- 这`8`种情况需要在添加之后修复红黑树。

- 其中前4种属于B树节点上溢的情况。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153653757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2.1 添加-修复性质4-LL\RR



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153701977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 首先看`52`和`60`，这两种情况分别属于`RR`和`LL`。

- 判定条件：`uncle`不是`RED`。

- 操作步骤：

  1. `parent`染成`BLACK`，`grand`染成`RED`。

  2. grand进行单旋操作。

     ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153710325.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2.2 添加-修复性质4-LR\RL



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153717773.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 看`48`和`74`，这两种情况属于`LR`和`RL`。

- 判定条件：`uncle`不是RED。

- 操作步骤：

  1. `自己`染成`BLACK`，`grand`染成`RED`。

  2. 进行`双旋`操作。

  3. 如果是`LR`，`parent`左旋转，`grand`右旋转。

  4. 如果是RL，parent右旋转，grand左旋转。

     ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020022215372557.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2.3 添加-修复性质4-上溢-LL



![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153732850.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 现在我们来添加`10`，`10`添加之后会导致上溢，这种情况属于`LL`。
- 判定条件：`uncle`是`RED`。
- 操作步骤：
  1. `parent`，`uncle`染成`BLACK`，成为独立节点。
  2. `grand`向上合并，染成`RED`，当作是新添加的节点进行处理。
  3. `grand`向上合并时，可能继续发生`上溢`，若`上溢`持续到`根节点`，只需将`根节点`染成`BLACK`。
- LL的情况不需要旋转，只需要染色。![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153740406.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2.4 添加-修复性质4-上溢-RR

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153747212.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 判定条件：`uncle`是`RED`。
- 操作步骤：
  1. `parent`，`uncle`染成`BLACK`，成为独立节点。
  2. `grand`向上合并，染成`RED`，当作是新添加的节点进行处理。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153800771.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



#### 2.2.5 添加-修复性质4-上溢-LR

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153807995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 判定条件：`uncle`是`RED`。

- 操作步骤：

  1. `parent`，`uncle`染成`BLACK`，成为独立节点。

  2. grand向上合并，染成RED，当作是新添加的节点进行处理。

     ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153813303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.2.6 添加-修复性质4-上溢-RL

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153819271.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)



- 判定条件：`uncle`是`RED`。

- 操作步骤：

  1. `parent`，`uncle`染成`BLACK`，成为独立节点。

  2. grand向上合并，染成RED，当作是新添加的节点进行处理。

     ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153824909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 2.3 添加总结

- 添加一共有`12`种情况。
- 其中有`4`种情况，添加之后`父节点`为`黑色`，添加之后不用做处理。依然满足性质`4`。
- 另外`8`种情况，添加之后`父节点`为`红色`，不满足性质`4`，需要进行双红修复处理。
- 修复分为两种情况：
  - uncle不是RED：
    - `LL\RR`，让`祖父节点`进行单旋转，染成`红色`，让`父节点`成为中心，并染成`黑色`。
    - `LR\RL`，让`祖父节点`和`父节点`进行旋转，让新添加成员成为中心节点，染成`黑色`，祖父节点染成`红色`。
  - uncle是RED：
    - `父节点`，`叔父节点`染成`黑色`。
    - `祖父节`点染成`红色`，并`上溢`。

#### 2.4 添加实现

- `rotateLeft`，`rotateRight`函数实现请查看平衡二叉搜索树（AVL）

```java
protected void afterAdd(Node<E> node) {
    Node<E> parent = node.parent;
    // 添加的是根节点 或者 上溢到达了根节点
    if (parent == null) {
        black(node);
        return;
    }
    // 如果父节点是黑色，直接返回
    if (isBlack(parent)) return;
		
    // 叔父节点
    Node<E> uncle = parent.sibling();
    // 祖父节点
    Node<E> grand = red(parent.parent);
    if (isRed(uncle)) { // 叔父节点是红色【B树节点上溢】
        black(parent);
        black(uncle);
        // 把祖父节点当做是新添加的节点
        afterAdd(grand);
        return;
    }
		
    // 叔父节点不是红色
    if (parent.isLeftChild()) { // L
        if (node.isLeftChild()) { // LL
            black(parent);
        } else { // LR
            black(node);
            rotateLeft(parent);
        }
        rotateRight(grand);
    } else { // R
        if (node.isLeftChild()) { // RL
            black(node);
            rotateRight(parent);
        } else { // RR
            black(parent);
        }
        rotateLeft(grand);
    }
}
```

### 3、删除

- B树中，最后真正被删除的元素都在叶子节点上。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153833574.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- 删除分为`删除RED节点`和`删除BLACK节点`两种情况。

- 删除RED节点，直接删除即可，不用做任何调整。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153840201.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- 删除BLACK节点分为3种情况。

  - 拥有2个RED子节点的BLACK节点，例如25。

    - 不可能被直接删除，因为会找它的`前驱`或`后继`子节点替代删除，因此不用考虑这种情况。

  - 拥有`1`个`RED子节点`的`BLACK节点`，例如`46`，`76`。

  - BLACK叶子节点，例如88。

    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153846613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 3.1 删除拥有1个RED子节点的BLACK节点

- 判定条件：删除指定节点后，用以代替的子节点是RED。

- 将替代的子节点染成BLACK即可保持红黑树的性质。

- 例如删除50和72。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/2020022215385294.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 3.2 删除 - BLACK叶子节点 - sibling为BLACK

- `BLACK叶子节`点被删除后，会导致B树节点`下溢`（比如删除`88`）。

#### 3.2.1 sibling至少有1个RED子节点

- 如果sibling至少有1个RED子节点：

  - 进行旋转操作。
  - 旋转之后的中心节点继承`parent`的颜色。
  - 旋转之后的左右节点染为`BLACK`。

- 如果sibling有2个RED子节点，那么可以选择删除其左子节点或右子节点，删除左子节点少做一次旋转。

  ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153900193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- 举例：

  - 删除`88`。

  - `76`左旋转，`80`右旋转。

  - 中心节点`(78)`继承`parent`的颜色`(80)`。

  - 80旋转下去之后，染成BLACK。

    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153909558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 3.2.2 sibling没有RED子节点

- 如果sibling没有1个RED子节点：

  - 将sibling染成RED，parent染成BLACK即可修复红黑树性质。

    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153915635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

- 如果parent是BLACK

  - 会导致`parent`也下溢。

  - 这时只需要把parent当作被删除的节点处理即可，相当于递归调afterremove。

    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153923973.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

#### 3.2.3 sibling为RED

- 如果sibling是RED：

  - `sibling`染成`BLACK`，parent染成`RED`，进行旋转。

  - 于是又回到sibling是BLACK的情况。

    ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200222153931729.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0MjU3Mzgz,size_16,color_FFFFFF,t_70)

